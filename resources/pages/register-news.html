<h1 class="h3 text-gray-800">{{pageTitle}}</h1>

<form id="form" style="margin: 0 auto; max-width: 720px">
  <input type="hidden" name="id" id="id" value="{{id}}" />

  <div class="my-4" id="photo-component">
    <div style="position: relative; height: 200px">
      <img
        src="/profile/{{photo}}"
        alt="..."
        style="
          width: 100%;
          height: 100%;
          box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
          object-fit: cover;
        "
      />
      <span
        class="overlay"
        style="
          position: absolute;
          left: 0;
          top: 0;
          color: white;
          background-color: rgba(0, 0, 0, 0.5);
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          visibility: hidden;
        "
        >Alterar imagem da notícia</span
      >
    </div>
    <input name="photo" id="photo" type="file" style="display: none" />
  </div>

  <div>
    <input
      id="title"
      class="container-fluid"
      name="title"
      type="text"
      value="{{title}}"
      placeholder="Digite o título aqui"
      style="padding: 2px"
    />
  </div>

  <hr />

  <div>
    <textarea
      id="summary"
      name="summary"
      style="resize: none; width: 100%"
      placeholder="Digite o resumo aqui"
    >
{{summary}}</textarea
    >
  </div>

  <div class="my-4">
    <label for="body">Conteúdo</label>
    <textarea id="body">{{body}}</textarea>
  </div>

  <hr />

  <div>
    <input type="checkbox" id="schedule-checkbox" />
    <label for="schedule-checkbox">Agendamento</label>
    <input
      id="schedule"
      name="schedule"
      type="datetime-local"
      value="{{schedule}}"
      style="display: none"
    />
  </div>

  <div>
    <input id="featured" type="checkbox" {{featured}} />
    <label for="featured">Em destaque</label>
  </div>

  <button id="publish" class="btn btn-primary container-fluid">Publicar</button>
</form>




<!-- Ckeditor Import -->
<script src="/ckeditor5-41.3.1/build/ckeditor.js"></script>



<style>
  /* This selector targets the editable element (excluding comments). */
  .ck-editor__editable_inline:not(.ck-comment__input *) {
    height: 300px;
    overflow-y: auto;
  }
</style>



<!--Create CK Editor-->
<script type="module" async>

  const editor = await createCkEditor("body");


  async function createCkEditor(id) {
    const element = document.getElementById(id);
    const editor = await ClassicEditor.create(element, {
      simpleUpload: {
        uploadUrl: "{{URL}}/api/fileuploader",
      },
    });

    window.editor = editor;
    return editor;
  }

</script>



<!--Schedule-->
<script>

  const schedule = document.querySelector("#schedule");
  const scheduleBtn = document.querySelector("#schedule-checkbox");
  setupHiddeBtn(scheduleBtn, schedule);



  function setupHiddeBtn(checkbox, element) {
    checkbox.addEventListener("click", () => {
      element.style.display = checkbox.checked ? "block" : "none";
    });
  }
</script>



<!--Submit Register/Edit News Form-->
<script>

  const publishBtn = document.querySelector("#publish");

  publishBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    Swal.fire({
      title: "{{processTitle}} notícia...",
      didOpen: async () => {
        Swal.showLoading();
      },
      allowOutsideClick: () => !Swal.isLoading(),
    });

    const response = await registerNews();


    if(response.success) {

      Swal.fire({
        title: response.message,
        icon: "success",
      }).then(() => {
        window.location.href = "/news";
      });

    } else {
      Swal.fire({
        title: "Falha ao {{errorTitle}} notícia!",
        html: response.message,
        icon: "error",
      }).then(() => {
      });
    }
  });


  async function registerNews() {

    try{
      const form = document.querySelector("#form");
      const formData = new FormData(form);

      let body = editor.getData();
      //body = body.replace(/style="[^"]*"/, "");
      //body = body.replace(/class="[^"]*"/, "");
      //body = body.replace(/width="[^"]*"/, "");
      //body = body.replace(/height="[^"]*"/, "");

      formData.append("body", body);

      const featured = document.querySelector("#featured");
      formData.append("featured", featured.checked);
  
      const response = await fetch("{{URL}}/{{path}}", {
        method: "POST",
        body: formData,
      });
  
      const data = await response.json();
      return data;

    } catch(error) {
      const data = {
        success: false,
        message: "Erro na conexão. Tente novamente."
      };
      return data;
    }

  }
</script>






<!-- Logica edicao de foto de perfil -->
<script>
  const profilePicture = document.querySelector("#photo-component");
  const photoInput = profilePicture.querySelector("#photo");
  const overlay = profilePicture.querySelector(".overlay");
  const profileImg = profilePicture.querySelector("img");

  profilePicture.addEventListener("mouseover", () => {
    overlay.style.visibility = "visible";
  });

  profilePicture.addEventListener("mouseout", () => {
    overlay.style.visibility = "hidden";
  });

  profilePicture.addEventListener("click", () => {
    photoInput.click();
  });

  photoInput.addEventListener("change", () => {
    const file = photoInput.files[0];
    if (file) {
      profileImg.src = URL.createObjectURL(file);
    }
  });
</script>

