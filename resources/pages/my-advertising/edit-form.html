<!-- Edit News Modal  -->
<div class="modal fade" id="edit-news-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-xl" role="document">
    <div class="modal-content">
      <!-- Modal Header-->
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Editar Notícia</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- Modal Body -->
      <div class="modal-body">

        <form id="edit-news-form"
          class="d-flex flex-column justify-content-around position-relative px-1 px-md-5 py-3">

          <input id="edit-id" name="newsId" type="hidden" value="">

          <div id="edit-photo-container" class="w-100 position-relative rounded overflow-hidden mb-1"
            style="height: 200px; cursor: pointer;">
            <img id="edit-photo-preview" class="w-100 h-100 shadow-sm" src="" alt="Imagem da notícia" style="
                object-fit: cover;              
              " />
            <span
              class="overlay position-absolute text-white d-flex align-items-center justify-content-center w-100 h-100"
              style="
                top: 0;
                left: 0;
                background-color: rgba(0, 0, 0, 0.5);
                font-size: 18px;
                visibility: hidden;
              ">
              Alterar imagem da notícia
            </span>
            <input id="edit-photo" name="photo" type="file" style="display: none" />
          </div>


          <div class="d-flex flex-column align-items-center mt-5 w-100">
            <input id="edit-title" name="title" type="text" class="container-fluid px-2 py-3 form-control w-100"
              style="font-size: 18px" placeholder="Qual é o título da notícia?" />
            <div class="mt-1 mb-0 d-flex w-100 justify-content-between">
              <p id="edit-title-message" class="text-danger" style="font-size: 14px; visibility: hidden;">Mínimo de
                10 caracteres</p>
              <p style="font-size: 14px;"><span id="edit-title-counter">0</span>/100</p>
            </div>
          </div>


          <div class="d-flex flex-column align-items-center my-4 w-100">
            <textarea id="edit-summary" name="summary" class="container-fluid px-2 py-2 form-control w-100"
              style="resize: none; font-size: 18px" placeholder="Escreva aqui um resumo sobre a notícia."></textarea>
            <div class="mt-1 mb-0 w-100 d-flex justify-content-between">
              <p id="edit-summary-message" class="text-danger" style="font-size: 14px; visibility: hidden;">Mínimo
                de 100 caracteres</p>
              <p style="font-size: 14px;"><span id="edit-summary-counter" style="font-size: 14px;">0</span>/150</p>
            </div>
          </div>


          <textarea id="edit-editor" name="body" class="px-2 py-2 container-fluid w-100 form-control"
            placeholder="Escreva aqui o corpo da notícia.">
          </textarea>


          <div
            class="d-flex flex-column flex-lg-row justify-content-around align-items-lg-center mt-5 bg-light rounded p-3 w-100"
            style="border:solid 1px #d1d3e2 ">

            <div class="mb-2 mb-md-0">
              <input id="edit-featured" name="featured" type="checkbox" class="mr-1" />
              <label for="edit-featured" style="margin-bottom: 0;">Colocar em destaque</label>
            </div>

            <div class="d-flex flex-column flex-lg-row justify-content-around align-items-lg-center">

              <div class="mb-1 mb-md-0">
                <input id="edit-schedule-checkbox" type="checkbox" class="mr-1" />
                <label for="edit-schedule-checkbox" style="margin-bottom: 0;" >Agendar publicação</label>
              </div>

              <div id="edit-schedule-container" class="ml-lg-5" style="display: none;">
                <input id="edit-schedule" name="schedule" type="datetime-local" class="form-control"/>
              </div>


            </div>

          </div>

          <button id="edit-news-submit-button" class="btn btn-primary container-fluid mt-4">Editar notícia</button>

        </form>

        <!-- End form Body -->
      </div>
 
      <div class="modal-footer d-flex justify-content-between px-5">
      </div>

    </div>
  </div>
</div>


<!--Create Edit News CK Editor-->
<script type="module" async>

  const editEditor = await createEditCkEditor("edit-editor");


  async function createEditCkEditor(id) {
    const element = document.getElementById(id);
    const editor = await ClassicEditor.create(element, {
      simpleUpload: {
        uploadUrl: "{{URL}}/api/fileuploader",
      },
    });

    window.editEditor = editor;
    return editor;
  }

</script>



<!--Apply Masks on Edit News Form Fields-->
<script>
  //--------------------- Title --------------------//
  document.getElementById("edit-title").addEventListener("input", () => {
    if (this.value.length > 100) {
      this.value = this.value.substring(0, 100);
    }
    if (this.value.length < 10 && this.value.length > 0) {
      document.getElementById("edit-title-message").style.visibility = "visible";
    } else {
      document.getElementById("edit-title-message").style.visibility = "hidden";
    }

    document.getElementById("edit-title-counter").innerHTML = this.value.length;
    //fullnameMask(this);
  });

  //-------------------- Summary --------------------//
  document.getElementById("edit-summary").addEventListener("input", () => {
    if (this.value.length > 150) {
      this.value = this.value.substring(0, 150);
    }

    if (this.value.length < 100 && this.value.length > 0) {
      document.getElementById("edit-summary-message").style.visibility = "visible";
    } else {
      document.getElementById("edit-summary-message").style.visibility = "hidden";
    }
    document.getElementById("edit-summary-counter").innerHTML = this.value.length;
    //usernameMask(this);
  });

</script>


<!--Logic of Edit News Schedule Display-->
<script>

  const editScheduleCheckBox = document.querySelector("#edit-schedule-checkbox");
  const editScheduleContainer = document.querySelector("#edit-schedule-container");


  changeScheduleDisplay(editScheduleCheckBox, editScheduleContainer);

</script>


<!--Set Edit News Button Tooltip and Click Event-->
<script>

  $(document).ready(() => {

    $("#edit-news-button").tooltip();

    $('#edit-news-button').on('click', () => {
      $('body').css('overflow-y', 'hidden');
    });

    $('#edit-news-modal').on('hidden.bs.modal', () => {

      $('body').css('overflow-y', 'scroll');
      $('#edit-title-message').css('visibility', 'hidden');
      $('#edit-summary-message').css('visibility', 'hidden');

      $('#edit-title-counter').html("0");
      $('#edit-summary-counter').html("0");


      $('#edit-photo').val('');
      $('#edit-photo-preview').attr('src', '/image/news/news-default.png');
      $('#edit-title').val('');
      $('#edit-summary').val('');
      editEditor.setData('');
      $('#edit-featured').prop('checked', false);
      $('#edit-schedule-checkbox').prop('checked', false);

      $('#edit-schedule-container').css('display', 'none');
      $('#edit-schedule').val('');

    });

  });

</script>


<!--Change edit News Photo Script-->
<script>
  const editPhotoContainer = document.getElementById("edit-photo-container");
  const editPhotoElement = editPhotoContainer.querySelector("img");
  const editPhotoOverlay = editPhotoContainer.querySelector("span");
  const editPhotoInput = editPhotoContainer.querySelector("input");

  editPhotoContainer.addEventListener("mouseover", () => {
    editPhotoOverlay.style.visibility = "visible";
  });

  editPhotoContainer.addEventListener("mouseout", () => {
    editPhotoOverlay.style.visibility = "hidden";
  });

  editPhotoContainer.addEventListener("click", () => {
    editPhotoInput.click();
  });


  var lastPhotoFile;

  editPhotoInput.addEventListener('change', async (event) => {

    const file = event.target.files[0];

    if (file) {

      let validPhotoNewsObject = await validNewsPhoto(editPhotoInput);

      if(!validPhotoNewsObject.success){

        editPhotoInput.value = "";

        document.getElementById("edit-news-modal").style.display = "none";

        Swal.fire({
          title: "Ocorreu um problema!",
          html: validPhotoNewsObject.message,
          icon: "error",
        }).then(() => {
          document.getElementById("edit-news-modal").style.display = "block";
        });

      } else {

        lastPhotoFile = file;

        const reader = new FileReader();
  
        reader.onload = function (event) {
          const photoUrl = event.target.result;
          editPhotoElement.src = photoUrl;
          //profilePhoto.style.backgroundImage = "url('" + photoUrl + "')";
        };

        reader.readAsDataURL(file);
      }

    } else {

      if (lastPhotoFile) {
        const fileList = new DataTransfer();
        fileList.items.add(new File([lastPhotoFile], lastPhotoFile.name));
        editPhotoInput.files = fileList.files;
      }
    }
  });
</script>



<!-- Fill Edit News Form -->
<script>

    async function fillEditNewsForm(newsId) {

        const response = await getNewsInfo(newsId);
  
        if (!response.success) {
          await Swal.fire({
            title: data.message, 
            icon: "error",
            position: "center",
          }).then(() => window.location.reload());
        } else {
          updateEditNewsForm(response.data);
        }
  
    }




    async function getNewsInfo(newsId) {
      try {
        const response = await fetch("/api/news/" + newsId);
        const data = await response.json();
        return data;
      } catch (error) {
        return {
          success: false,
          message: "Erro na conexão. Tente novamente.",
        }
      }
    }
  
  
  
    function updateEditNewsForm(data) {

      const id = document.querySelector("#edit-id");
      const photo = document.querySelector("#edit-photo-preview");
      const title = document.querySelector("#edit-title");
      const summary = document.querySelector("#edit-summary");
      const body = editEditor;
      const featured = document.querySelector("#edit-featured");
      const scheduleCheckBox = document.querySelector("#edit-schedule-checkbox");
      const scheduleContainer = document.querySelector("#edit-schedule-container");
      const schedule = document.querySelector("#edit-schedule");

      id.value = data.id;
      photo.src = data.photo
      title.value = data.title;
      summary.value = data.summary;
      body.setData(data.body);
      featured.checked = data.featured;
      scheduleCheckBox.checked = data.scheduleCheckBox;
      scheduleContainer.style.display = data.scheduleContainer;
      schedule.value = data.schedule;   
    }

  </script>



<!--Submit edit News Form-->
<script>

  const editNewsSubmitButton = document.querySelector("#edit-news-submit-button");

  editNewsSubmitButton.addEventListener("click", async (e) => {
    e.preventDefault();

    Swal.fire({
      title: "Editando notícia...",
      didOpen: async () => {
        Swal.showLoading();
        document.getElementById("edit-news-modal").style.display = "none";
      },
      allowOutsideClick: () => !Swal.isLoading(),
    });

    const response = await editNews();

    if (response.success) {
      Swal.fire({
        title: "Notícia editada com sucesso!",
        icon: "success",
      }).then(() => {
        window.location.reload();
      });

    } else {
      Swal.fire({
        title: "Falha ao editar notícia!",
        html: response.message,
        icon: "error",
      }).then(() => {
        document.getElementById("edit-news-modal").style.display = "block";
      });
    }
  });



  async function editNews() {


    var photoInput = document.getElementById("edit-photo");
    var scheduleCheckbox = document.getElementById("edit-schedule-checkbox");
    var scheduleInput = document.getElementById("edit-schedule");

    //console.log(scheduleInput.value);

    //console.log(photoInput);

    if (photoInput.files.length != 0) {
      var validNewsPhotoObject = await validNewsPhoto(photoInput);

      if (await !validNewsPhotoObject.success) {
        return await new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve(
              validNewsPhotoObject
            );
          });
        });
      }
    }



    if(scheduleCheckbox.checked){
      if(scheduleInput.value == ""){
        return await new Promise((resolve, reject) => {
          setTimeout(() =>  {
            resolve({
              success: false,
              message: "Por favor, informe a <strong>data de agendamento</strong> corretamente."
            }
            );
          });
        });

      } else {

        var validScheduleNewsObject = await validScheduleNews(scheduleInput)

        if (await !validScheduleNewsObject.success) {
          return await new Promise((resolve, reject) => {
            setTimeout(() => {
              resolve(
                validScheduleNewsObject
              );
            });
          });
        }
      }
    }


    const form = document.querySelector("#edit-news-form");
    const formData = new FormData(form);

    let body = editEditor.getData();
    //body = body.replace(/style="[^"]*"/, "");
    //body = body.replace(/class="[^"]*"/, "");
    //body = body.replace(/width="[^"]*"/, "");
    //body = body.replace(/height="[^"]*"/, "");


    formData.append("body", body);

    const editFeatured = document.querySelector("#edit-featured");
    formData.append("featured", editFeatured.checked);

    formData.append("schedule",  scheduleInput.value == "" ? scheduleInput.value : scheduleInput.value.replace(/\T/g, " ") + ":00");

    try {
      const response = await fetch("/api/news/edit", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      return data;

    } catch (error) {
      const data = {
        success: false,
        message: "Erro na conexão. Tente novamente."
      };
      return data;
    }
  }

</script>