<!-- Register News Button  -->
<button id="register-news-button" type="button" data-placement="top" title="Cadastrar notícia"
  class="btn  btn-primary btn-circle" data-toggle="modal" data-target="#register-news-modal">
  <i class="fas fa-newspaper"></i>
</button>

<!-- Register News Modal  -->
<div class="modal fade" id="register-news-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-xl" role="document">
    <div class="modal-content">
      <!-- Modal Header-->
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Cadastrar Notícia</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- Modal Body -->
      <div class="modal-body">

        <form id="register-news-form"
          class="d-flex flex-column justify-content-around position-relative px-1 px-md-5 py-3">

          <div id="register-photo-container" class="w-100 position-relative rounded overflow-hidden mb-1"
            style="height: 200px; cursor: pointer;">
            <img id="register-photo-preview" class="w-100 h-100 shadow-sm" src="/image/news/news-default.png" alt="Imagem padrão da notícia" style="
                object-fit: cover;              
              " />
            <span
              class="overlay position-absolute text-white d-flex align-items-center justify-content-center w-100 h-100"
              style="
                top: 0;
                left: 0;
                background-color: rgba(0, 0, 0, 0.5);
                font-size: 18px;
                visibility: hidden;
              ">
              Alterar imagem da notícia
            </span>
            <input id="register-photo" name="photo" type="file" style="display: none" />
          </div>


          <div class="d-flex flex-column align-items-center mt-5 w-100">
            <input id="register-title" name="title" type="text" class="container-fluid px-2 py-3 form-control w-100"
              style="font-size: 18px" placeholder="Qual é o título da notícia?" />
            <div class="mt-1 mb-0 d-flex w-100 justify-content-between">
              <p id="register-title-message" class="text-danger" style="font-size: 14px; visibility: hidden;">Mínimo de
                10 caracteres</p>
              <p style="font-size: 14px;"><span id="register-title-counter">0</span>/100</p>
            </div>
          </div>


          <div class="d-flex flex-column align-items-center my-4 w-100">
            <textarea id="register-summary" name="summary" class="container-fluid px-2 py-2 form-control w-100"
              style="resize: none; font-size: 18px" placeholder="Escreva aqui um resumo sobre a notícia."></textarea>
            <div class="mt-1 mb-0 w-100 d-flex justify-content-between">
              <p id="register-summary-message" class="text-danger" style="font-size: 14px; visibility: hidden;">Mínimo
                de 100 caracteres</p>
              <p style="font-size: 14px;"><span id="register-summary-counter" style="font-size: 14px;">0</span>/150</p>
            </div>
          </div>


          <textarea id="register-editor" name="body" class="px-2 py-2 container-fluid w-100 form-control"
            placeholder="Escreva aqui o corpo da notícia.">
          </textarea>


          <div
            class="d-flex flex-column flex-lg-row justify-content-around align-items-lg-center mt-5 bg-light rounded p-3 w-100"
            style="border:solid 1px #d1d3e2 ">

            <div class="mb-2 mb-md-0">
              <input id="register-featured" name="featured" type="checkbox" class="mr-1" />
              <label for="register-featured" style="margin-bottom: 0;">Colocar em destaque</label>
            </div>

            <div class="d-flex flex-column flex-lg-row justify-content-around align-items-lg-center">

              <div class="mb-1 mb-md-0">
                <input id="register-schedule-checkbox" type="checkbox" class="mr-1" />
                <label for="register-schedule-checkbox" style="margin-bottom: 0;" >Agendar publicação</label>
              </div>

              <div id="register-schedule-container" class="ml-lg-5" style="display: none;">
                <input id="register-schedule" name="schedule" type="datetime-local" class="form-control"/>
              </div>


            </div>

          </div>

          <button id="register-news-submit-button" class="btn btn-primary container-fluid mt-4">Cadastrar notícia</button>

        </form>

        <!-- End form Body -->
      </div>
 
      <div class="modal-footer d-flex justify-content-between px-5">
      </div>

    </div>
  </div>
</div>




<!-- Ckeditor Import -->
<script src="/ckeditor5-41.3.1/build/ckeditor.js"></script>


<!--Set Ckeditor Container Styles-->
<style>
  /* This selector targets the editable element (excluding comments). */
  .ck-editor__editable_inline:not(.ck-comment__input *) {
    height: 300px;
    overflow-y: auto;
    font-size: 18px;
  }
</style>


<!--Create Register News CK Editor-->
<script type="module" async>

  const registerEditor = await createRegisterCkEditor("register-editor");


  async function createRegisterCkEditor(id) {
    const element = document.getElementById(id);
    const editor = await ClassicEditor.create(element, {
      simpleUpload: {
        uploadUrl: "{{URL}}/api/fileuploader",
      },
    });

    window.registerEditor = editor;
    return editor;
  }

</script>



<!--Apply Masks on Register News Form Fields-->
<script>
  //--------------------- Title --------------------//
  document.getElementById("register-title").addEventListener("input", () => {
    if (this.value.length > 100) {
      this.value = this.value.substring(0, 100);
    }
    if (this.value.length < 10 && this.value.length > 0) {
      document.getElementById("register-title-message").style.visibility = "visible";
    } else {
      document.getElementById("register-title-message").style.visibility = "hidden";
    }

    document.getElementById("register-title-counter").innerHTML = this.value.length;
    //fullnameMask(this);
  });

  //-------------------- Summary --------------------//
  document.getElementById("register-summary").addEventListener("input", () => {
    if (this.value.length > 150) {
      this.value = this.value.substring(0, 150);
    }

    if (this.value.length < 100 && this.value.length > 0) {
      document.getElementById("register-summary-message").style.visibility = "visible";
    } else {
      document.getElementById("register-summary-message").style.visibility = "hidden";
    }
    document.getElementById("register-summary-counter").innerHTML = this.value.length;
    //usernameMask(this);
  });

</script>


<!--Logic of Register News Schedule Display-->
<script>

  function changeScheduleDisplay(scheduleCheckBox, scheduleContainer) {
    scheduleCheckBox.addEventListener("click", () => {
      scheduleContainer.style.display = scheduleCheckBox.checked ? "flex" : "none";

      if(!scheduleCheckBox.checked){
        scheduleContainer.querySelector("input").value =  "" ;
      }

    });
  }

  const registerScheduleCheckBox = document.querySelector("#register-schedule-checkbox");
  const registerScheduleContainer = document.querySelector("#register-schedule-container");


  changeScheduleDisplay(registerScheduleCheckBox, registerScheduleContainer);

</script>


<!--Set Register News Button Tooltip and Click Event-->
<script>

  $(document).ready(() => {

    $("#register-news-button").tooltip();

    $('#register-news-button').on('click', () => {
      $('body').css('overflow-y', 'hidden');
    });

    $('#register-news-modal').on('hidden.bs.modal', () => {

      $('body').css('overflow-y', 'scroll');
      $('#register-title-message').css('visibility', 'hidden');
      $('#register-summary-message').css('visibility', 'hidden');

      $('#register-title-counter').html("0");
      $('#register-summary-counter').html("0");


      $('#register-photo').val('');
      $('#register-photo-preview').attr('src', '/image/news/news-default.png');
      $('#register-title').val('');
      $('#register-summary').val('');
      registerEditor.setData('');
      $('#register-featured').prop('checked', false);
      $('#register-schedule-checkbox').prop('checked', false);

      $('#register-schedule-container').css('display', 'none');
      $('#register-schedule').val('');

    });

  });

</script>



<!--Photo News Validation-->
<script>

  async function validNewsPhoto(input) {

    let file = input.files[0];

    if (file.size > 5000000) {
      return {
        success: false,
        message: "Tamanho máximo de 5MB excedido para <strong>imagem da notícia</strong>."
      };
    }


    try {

      const arrayBuffer = await readFileAsArrayBuffer(file);

      const text = await readFileAsText(file);
      const svgPattern = /<svg[^>]*xmlns="http:\/\/www\.w3\.org\/2000\/svg"[^>]*>/;
      const isSVG = svgPattern.test(text);

      const isValidFormat = (IsOtherFileFormat(arrayBuffer) || isSVG);


      if (!isValidFormat) {
        return {
          success: false,
          message: "Tipo de arquivo inválido para <strong>imagem da notícia</strong>."
        };
      }




      return {
        success: true,
        message: "Imagem da notícia válida."
      };


    } catch (error) {
      return {
        success: false,
        message: "Erro ao carregar <strong>imagem da notícia</strong>. Tente novamente."
      };
    }
  }

  

  function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = function (event) {
        resolve(new Uint8Array(event.target.result));
      };

      reader.onerror = function (event) {
        reject(event);
      };

      reader.readAsArrayBuffer(file);
    });
  }


  function readFileAsText(file){

    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = function (event) {
        resolve(event.target.result);
      };

      reader.onerror = function (event) {
        reject(event);
      };

      reader.readAsText(file);
    });

  }


  function IsOtherFileFormat(arrayBuffer) {

    let fileCodes = ["89504e47", "ffd8ffdb", "ffd8ffe0", "ffd8ffee", "ffd8ffe1", "0000000c", "ff4fff51", "52494646"];

    var arr = arrayBuffer.subarray(0, 4);
    var header = "";
    for (var i = 0; i < arr.length; i++) {
      header += arr[i].toString(16);
    }

    if (!fileCodes.includes(header)) {
      return false;
    }
    return true;
  }


</script>


<!--Change Register News Photo Script-->
<script>
  const registerPhotoContainer = document.getElementById("register-photo-container");
  const registerPhotoElement = registerPhotoContainer.querySelector("img");
  const registerPhotoOverlay = registerPhotoContainer.querySelector("span");
  const registerPhotoInput = registerPhotoContainer.querySelector("input");

  registerPhotoContainer.addEventListener("mouseover", () => {
    registerPhotoOverlay.style.visibility = "visible";
  });

  registerPhotoContainer.addEventListener("mouseout", () => {
    registerPhotoOverlay.style.visibility = "hidden";
  });

  registerPhotoContainer.addEventListener("click", () => {
    registerPhotoInput.click();
  });


  var lastPhotoFile;

  registerPhotoInput.addEventListener('change', async (event) => {

    const file = event.target.files[0];

    if (file) {

      let validPhotoNewsObject = await validNewsPhoto(registerPhotoInput);

      if(!validPhotoNewsObject.success){

        registerPhotoInput.value = "";

        document.getElementById("register-news-modal").style.display = "none";

        Swal.fire({
          title: "Ocorreu um problema!",
          html: validPhotoNewsObject.message,
          icon: "error",
        }).then(() => {
          document.getElementById("register-news-modal").style.display = "block";
        });

      } else {

        lastPhotoFile = file;

        const reader = new FileReader();
  
        reader.onload = function (event) {
          const photoUrl = event.target.result;
          registerPhotoElement.src = photoUrl;
          //profilePhoto.style.backgroundImage = "url('" + photoUrl + "')";
        };

        reader.readAsDataURL(file);
      }

    } else {

      if (lastPhotoFile) {
        const fileList = new DataTransfer();
        fileList.items.add(new File([lastPhotoFile], lastPhotoFile.name));
        registerPhotoInput.files = fileList.files;
      }
    }
  });
</script>


<!--Schedule News Validation-->
<script>
  async function validScheduleNews(input) {

    let scheduleValue = input.value;

    let scheduleYear = scheduleValue.split("-")[0];

    if(scheduleYear.length != 4){
      return {
        success: false,
        message: "<strong>Data de agendamento</strong> inválida."
      }
    }

    /*let currentDate = await getCurrentDate();

    if(currentDate == false) {
      return {
        success: false,
        message: "Problema ao validar <strong>data de agendamento</strong>."
      }
    }

    //console.log(currentDate);


    scheduleValue = new Date(scheduleValue);
    currentDate = new Date(currentDate);

    if(scheduleValue < currentDate){
      return {
        success: false,
        message: "A <strong>data de agendamento</strong> não pode ser anterior à data atual."
      }
    }*/

    return {
      success: true,
      message: "<strong>Data de agendamento</strong> parcialmente válida."
    }

  }

  /*async function getCurrentDate(){

    try{

      let response = await fetch("/api/general/current-date", {                
        method: "GET"
      });
  
      let data = await response.json();

      if(data.success){
        return data.currentDate;
      } else {
        return false;
      }

    } catch (error) {
      return false;
    }

  }*/

</script>


<!--Submit Register News Form-->
<script>

  const registerNewsSubmitButton = document.querySelector("#register-news-submit-button");

  registerNewsSubmitButton.addEventListener("click", async (e) => {
    e.preventDefault();

    Swal.fire({
      title: "Cadastrando notícia...",
      didOpen: async () => {
        Swal.showLoading();
        document.getElementById("register-news-modal").style.display = "none";
      },
      allowOutsideClick: () => !Swal.isLoading(),
    });

    const response = await registerNews();

    if (response.success) {
      Swal.fire({
        title: "Notícia cadastrada com sucesso!",
        icon: "success",
      }).then(() => {
        window.location.reload();
      });

    } else {
      Swal.fire({
        title: "Falha ao cadastrar notícia!",
        html: response.message,
        icon: "error",
      }).then(() => {
        document.getElementById("register-news-modal").style.display = "block";
      });
    }
  });



  async function registerNews() {


    var photoInput = document.getElementById("register-photo");
    var scheduleCheckbox = document.getElementById("register-schedule-checkbox");
    var scheduleInput = document.getElementById("register-schedule");

    //console.log(scheduleInput.value);

    //console.log(photoInput);

    if (photoInput.files.length != 0) {
      var validNewsPhotoObject = await validNewsPhoto(photoInput);

      if (await !validNewsPhotoObject.success) {
        return await new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve(
              validNewsPhotoObject
            );
          });
        });
      }
    }



    if(scheduleCheckbox.checked){
      if(scheduleInput.value == ""){
        return await new Promise((resolve, reject) => {
          setTimeout(() =>  {
            resolve({
              success: false,
              message: "Por favor, informe a <strong>data de agendamento</strong> corretamente."
            }
            );
          });
        });

      } else {

        var validScheduleNewsObject = await validScheduleNews(scheduleInput)

        if (await !validScheduleNewsObject.success) {
          return await new Promise((resolve, reject) => {
            setTimeout(() => {
              resolve(
                validScheduleNewsObject
              );
            });
          });
        }
      }
    }


    const form = document.querySelector("#register-news-form");
    const formData = new FormData(form);

    let body = registerEditor.getData();
    //body = body.replace(/style="[^"]*"/, "");
    //body = body.replace(/class="[^"]*"/, "");
    //body = body.replace(/width="[^"]*"/, "");
    //body = body.replace(/height="[^"]*"/, "");


    formData.append("body", body);

    const registerFeatured = document.querySelector("#register-featured");
    formData.append("featured", registerFeatured.checked);

    formData.append("schedule",  scheduleInput.value == "" ? scheduleInput.value : scheduleInput.value.replace(/\T/g, " ") + ":00");

    try {
      const response = await fetch("/api/news/register", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      return data;

    } catch (error) {
      const data = {
        success: false,
        message: "Erro na conexão. Tente novamente."
      };
      return data;
    }
  }

</script>