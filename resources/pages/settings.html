<h1 class="h3 my-4 text-gray-800">Configurações</h1>


<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex justify-content-between align-items-center position-relative"
    style="overflow: hidden">
    <h6 class="m-0 font-weight-bold text-primary">Informações pessoais</h6>

    <button type="submit" class="edit-button btn w-100 btn-primary d-none d-sm-flex justify-content-center"
      style="max-width: 200px;">
      Alterar informações
    </button>

  </div>


  <div class="card-body px-md-5 px-lg-5 flex-column">

    <form id="form" class="row align-items-center justify-content-between" enctype="multipart/form-data">
      <div id="profile-picture-component" class="col-12 my-3 col-md-12 col-lg-6 d-flex justify-content-center"
        >
        <div 
          id="photo-container"
          class="position-relative overflow-hidden d-flex justify-content-center text-center"
          style="width: 65%; padding-bottom: 65%; cursor: pointer;">

          <div 
              id="profile-photo"
              class="img-profile position-absolute top-50 start-50 translate-middle 
                w-100 h-100 rounded-circle shadow-sm" 
              style=" background-image: url(&quot;/profile/{{profile}}&quot;);
                background-position: center center; background-size: cover;
                background-repeat: no-repeat;"
          >
          </div>
          <span 
            id="photo-overlay"
            class="overlay position-absolute top-50 start-50 
              translate-middle w-100 h-100 rounded-circle text-light 
              d-flex align-items-center justify-content-center"
            style="background-color: rgba(0 ,0 , 0, 0.5); visibility: hidden;"
          >
            Alterar foto de perfil
          </span>
        </div>
        <input name="photo" id="photo-edit" type="file" style="display: none" />
      </div>


      <div class="col-12 col-md-12 col-lg-6 my-3">
        <input name="userId" id="id-user" type="hidden" value="{{id}}" />

        <div class="form-group">
          <label for="fullname-edit">Nome completo</label>
          <input id="fullname-edit" name="fullname" type="text" class="form-control" value="{{fullname}}" />
        </div>

        <div class="form-group">
          <label for="username-edit">Nome de Usuário</label>
          <input id="username-edit" name="username" type="text" autocomplete="off" class="form-control"
            value="{{username}}" />
        </div>


        <div class="form-group">
          <label for="email-edit">Email</label>
          <input id="email-edit" name="email" type="text" autocomplete="off" class="form-control" value="{{email}}" />
        </div>

        <div class="form-group">
          <label for="cpf-edit">CPF</label>
          <input id="cpf-edit" name="cpf" type="text" class="form-control" value="{{cpf}}" />
        </div>
      </div>
    </form>
  </div>

  <div class="card-footer py-3">
    <div class="row justify-content-center">
      <button type="submit" class="edit-button d-sm-none btn w-100 btn-primary" style="max-width: 500px;">
        Alterar informações
      </button>
    </div>
  </div>
</div>

<div class="card shadow mb-4">
  <div class="card-header py-3 d-flex justify-content-between align-items-center position-relative"
    style="overflow: hidden">
    <h6 class="m-0 font-weight-bold text-primary">Nova senha</h6>
    <button class="change-password-button d-none d-sm-flex w-100 btn btn-danger justify-content-center"
      style="max-width: 200px;">
      Alterar senha
    </button>
  </div>


  <div class="card-body px-md-5 px-lg-5">

    <form class="mx-auto" enctype="multipart/form-data" style="max-width: 500px">

      <div class="form-group">
        <label for="password-edit">Senha atual</label>

        <input id="password-edit" name="password" type="password" class="form-control" />
      </div>

      <div class="form-group">
        <label for="password-edit-new">Nova senha</label>
        <input id="password-edit-new" type="password" class="form-control" />
      </div>

      <div class="form-group">
        <label for="password-confirm-new">Confirmar nova senha</label>
        <input id="password-confirm-new" type="password" class="form-control" />
      </div>
    </form>

  </div>

  <div class="card-footer py-3">
    <div class="row justify-content-center">
      <button class="change-password-button d-sm-none w-100 btn btn-danger" style="max-width: 500px;">
        Alterar senha
      </button>
    </div>
  </div>
</div>





<!--Masks Functions-->
<script>
  //------------------ Last key pressed -------------------//
  let lastKeyPressed = "";
  document.addEventListener("keydown", function (e) {
    lastKeyPressed = e.key;
  });



  //------------------- Fullname -------------------//
  function fullnameMask(input) {
    const cursorPosition = input.selectionStart;

    const alphaRegex = /[^\sa-zA-ZàáâãéêíóôõúÀÁÂÃÉÊÍÓÔÕÚçÇ']|^\s+$|^'/g;

    if (alphaRegex.test(input.value)) {
      input.value = input.value.replace(alphaRegex, "");
      input.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
    }

    if (/\s{2,}/g.test(input.value)) {
      input.value = input.value.replace(/\s{2,}/g, " ");
      input.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
    }

    if (/'{2,}/g.test(input.value)) {
      input.value = input.value.replace(/'{2,}/g, "'");
      input.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
    }
  }

  //------------------- Username -------------------//
  function usernameMask(input) {
    const cursorPosition = input.selectionStart;

    const alphaRegex = /[^a-zA-Z0-9._]|^_|_$|^\.|\.$/g;

    if (alphaRegex.test(input.value)) {
      input.value = input.value.replace(alphaRegex, "");
      input.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
    }

    if (/_{2,}/g.test(input.value)) {
      input.value = input.value.replace(/_{2,}/g, "_");
      input.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
    }

    if (/\.{2,}/g.test(input.value)) {
      input.value = input.value.replace(/\.{2,}/g, ".");
      input.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
    }
  }

  //-------------------- Email ---------------------//
  function emailMask(input) {
    const cursorPosition = input.selectionStart;
    const emailRegex = /[^a-zA-Z0-9@_.-]/g;

    if (emailRegex.test(input.value)) {
      input.value = input.value.replace(emailRegex, "");
      input.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
      return;
    }
    input.setSelectionRange(cursorPosition, cursorPosition);
  }

</script>


<!--Apply Masks on Settings Form fields-->
<script>
  //------------------- Fullname -------------------//
  document.getElementById("fullname-edit").addEventListener("input", function () {
    if (this.value.length > 255) {
      this.value = this.value.substring(0, 255);
    }
    fullnameMask(this);
  });

  //------------------- Username -------------------//
  document.getElementById("username-edit").addEventListener("input", function () {
    if (this.value.length > 20) {
      this.value = this.value.substring(0, 20);
    }
    usernameMask(this);
  });

  //-------------------- Email ---------------------//
  document.getElementById("email-edit").addEventListener("input", function () {
    if (this.value.length > 255) {
      this.value = this.value.substring(0, 255);
    }
    emailMask(this);
  });


  //----------------------- CPF -----------------------//
  var pasteCpfEdit = false;

  document.getElementById("cpf-edit").addEventListener("paste", function () {
    pasteCpfEdit = true;
  });

  document.getElementById("cpf-edit").addEventListener("input", function () {
    let mask = "###.###.###-##";
    let cursorPosition = this.selectionStart;
    let beforeCriticalChars = cursorPosition === 3 || cursorPosition === 7 || cursorPosition === 11;
    let afterCriticalChars = cursorPosition === 4 || cursorPosition === 8 || cursorPosition === 12;
    let backspaceCodition = lastKeyPressed === "Backspace";
    let criticalBackspaceCodition = beforeCriticalChars && backspaceCodition

    let maskedArray = mask.split("");


    let digitsOnly = criticalBackspaceCodition ?
      (this.value.slice(0, cursorPosition - 1) + this.value.slice(cursorPosition)).replace(/[^0-9]/g, "") :
      this.value.replace(/[^0-9]/g, "");


    for (let i = 0; i < digitsOnly.length; i++) {
      if (maskedArray.indexOf("#") !== -1) {
        maskedArray.splice(maskedArray.indexOf("#"), 1, digitsOnly[i]);
      }
    }

    let newValue = "";

    if (maskedArray.indexOf("#") === -1) {
      newValue = this.value = maskedArray.join("");
    } else {
      newValue = this.value = maskedArray.slice(0, maskedArray.indexOf("#")).join("");
    }


    if (pasteCpfEdit) {
      this.setSelectionRange(newValue.length, newValue.length);
      return;
    }
    if (criticalBackspaceCodition) {
      this.setSelectionRange(cursorPosition - 1, cursorPosition - 1);
      return;
    }
    if (backspaceCodition) {
      this.setSelectionRange(cursorPosition, cursorPosition);
      return;
    }
    if (beforeCriticalChars || afterCriticalChars) {
      this.setSelectionRange(cursorPosition + 1, cursorPosition + 1);
      return;
    }
    this.setSelectionRange(cursorPosition, cursorPosition);

  });

</script>


<!-- Photo Profile Logic Edition-->
<script>

  const photoContainer = document.getElementById("photo-container");
  const photoOverlay = document.getElementById("photo-overlay");
  const profilePhoto = document.getElementById("profile-photo");
  const photoInput = document.getElementById("photo-edit");

  photoContainer.addEventListener("mouseover", () => {
    photoOverlay .style.visibility = "visible";
  });

  photoContainer.addEventListener("mouseout", () => {
    photoOverlay .style.visibility = "hidden";
  });

  photoContainer.addEventListener("click", () => {
    photoInput.click();
  });


  var lastPhotoFile;

photoInput.addEventListener('change', function(event) {
  const file = event.target.files[0];

  if (file) {
    lastPhotoFile = file; 

    const reader = new FileReader();
  
    reader.onload = function(event) {
      const photoUrl = event.target.result;
      profilePhoto.style.backgroundImage = "url('" + photoUrl + "')";
    };
    
    reader.readAsDataURL(file);
  } else {
    if (lastPhotoFile) {
      const fileList = new DataTransfer();
      fileList.items.add(new File([lastPhotoFile], lastPhotoFile.name));
      photoInput.files = fileList.files;
    } 
  }
});


</script>



<!--Photo Profile Validation-->
<script>

  async function validPhotoProfile(input) {

    let file = input.files[0];

    if (file.size > 5000000) {
      return {
        success: false,
        message: "Tamanho máximo de 5MB excedido para <strong>foto de perfil</strong>."
      };
    }


    try {
      const arrayBuffer = await readFileAsync(file);
      const isValidFormat = checkFileFormat(arrayBuffer);

      if (!isValidFormat) {
        return {
          success: false,
          message: "Tipo de arquivo inválido para <strong>foto de perfil</strong>."
        };
      }

      return {
        success: true,
        message: "Foto de perfil válida."
      };


    } catch (error) {
      return {
        success: false,
        message: "Erro ao carregar <strong>foto de perfil</strong>. Tente novamente."
      };
    }
  }

  function readFileAsync(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onloadend = function (e) {
        resolve(new Uint8Array(e.target.result));
      };

      reader.onerror = function (e) {
        reject(e);
      };

      reader.readAsArrayBuffer(file);
    });
  }

  function checkFileFormat(arrayBuffer) {

    let fileCodes = ["89504e47", "ffd8ffdb", "ffd8ffe0", "ffd8ffee", "ffd8ffe1", "0000000c", "ff4fff51"];

    var arr = arrayBuffer.subarray(0, 4);
    var header = "";
    for (var i = 0; i < arr.length; i++) {
      header += arr[i].toString(16);
    }

    if (!fileCodes.includes(header)) {
      return false;
    }
    return true;
  }

</script>


<!--Submit Pessoal Informations Form-->
<script>
  const editButtons = document.querySelectorAll(".edit-button");

  editButtons.forEach((editButton) => {
    editButton.addEventListener("click", async (event) => {
      event.preventDefault();
      Swal.fire({
        title: "Alterando informações...",
        didOpen: async () => {
          Swal.showLoading();
        },
        allowOutsideClick: () => !Swal.isLoading()
      });

      const response = await changeFields();

      if (response.success) {
        Swal.fire({
          title: "Alterações efetuadas com sucesso!",
          icon: "success"
        }).then(() =>  {
          window.location.reload()
        });
        
      } else {
        Swal.fire({
          title: "Falha ao alterar informações!",
          html: response.message,
          icon: "error"
        });
      }
    });
  });


  async function changeFields() {

    var photoElement = document.getElementById("photo-edit");

    //console.log(photoElement);


    if (photoElement.files.length != 0) {

      var validPhotoProfileObject = await validPhotoProfile(photoElement);

      if (await !validPhotoProfileObject.success) {
        return await new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve(
              validPhotoProfileObject
            );
          });
        });
      }
    }


    try {
      const form = document.querySelector("#form");
      const formData = new FormData(form);

      const res = await fetch("/api/user/general", {
        method: "POST",
        body: formData,
      });

      const data = await res.json();
      return data;

    } catch (error) {
      const data = {
        success: false,
        message: "Erro na conexão. Tente novamente."
      };
      return data;
    }
  }

</script>


<!--Submit Change Password Form-->
<script>

  const passwordButtons = document.querySelectorAll(".change-password-button");

  passwordButtons.forEach((passwordButton) => {
    passwordButton.addEventListener("click", async (e) => {
      e.preventDefault();

      Swal.fire({
        title: "Alterando senha...",
        didOpen: async () => {
          Swal.showLoading();
        },
        allowOutsideClick: () => !Swal.isLoading()
      });

      const response = await changePassword();

      if (response.success) {
        Swal.fire({
          title: response.message,
          icon: "success",
        }).then(() => window.location.reload());
      } else {
        Swal.fire({
          title: "Falha ao alterar senha!",
          html: response.message,
          icon: "error",
        });
      }

      if (data.success) {
        clearFields([
          "password-edit",
          "password-edit-new",
          "password-confirm-new",
        ]);
      }
    });


  });


  async function changePassword() {
    const id = document.querySelector("#id-user");
    const password = document.querySelector("#password-edit");
    const newPassword = document.querySelector("#password-edit-new");
    const confirmPassword = document.querySelector("#password-confirm-new");

    if (newPassword.value != confirmPassword.value) {
      return await new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve({
            success: false,
            message: "Senhas devem coincidir."
          });
        })
      })
    }

    try {
      const res = await fetch("/api/user/password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          userId: id.value,
          crrPass: password.value,
          newPass: newPassword.value,
        }),
      });

      const data = await res.json();
      return data;

    } catch (error) {
      return {
        success: false,
        message: "Falha na conexão. Tente novamente",
      };
    }
  }


  function clearFields(fields) {
    fields.forEach((id) => {
      document.querySelector("#" + id).value = "";
    });
  }
</script>